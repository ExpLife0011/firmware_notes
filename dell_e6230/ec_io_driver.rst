SmmEcIoDriver 的分析
=====================

在 `上篇文章 <smm_event.rst>`__ 的末尾，我说要分析 GUID 为 7310e28e-... 的协议。用 UEFITool 找了一下，有 30 个 UEFI 模块包含了这个 GUID，去掉依赖于这个 GUID 的模块，还是有不少的模块，不过最引人注目的就是 SmmEcIoDriver. 对于我要做的分析来说，这个名字的吸引力太大了，因为我的目的是找到 EC 启用 ACPI 模式的关键代码，而要做到这件事，就当然要对 EC 做 I/O 操作。只是之前的分析中没在这个模块中找到什么有用的信息，才暂时没分析它。现在是时候对这个模块做分析了。

可喜的是，在模块的入口函数处就找到了下列指令序列::

 |       |   0x180001dc9      488b05b00900.  mov rax, qword [0x180002780] ; [0x180002780:8]=0
 |       |   0x180001dd0      488364243000   and qword [local_30h], 0
 |       |   0x180001dd6      4c8d0d930700.  lea r9, [0x180002570]
 |       |   0x180001ddd      488d15340800.  lea rdx, [0x180002618]
 |       |   0x180001de4      488d4c2430     lea rcx, [local_30h]       ; 0x30 ; '0' ; 48
 |       |   0x180001de9      4533c0         xor r8d, r8d
 |       |   0x180001dec      ff5008         call qword [rax + 8]       ; 8

其中 0x180002618 指向的就是 7310e28e-... 这个 GUID，接下来当然就是看 r9 指向的那个接口了，尤其是偏移 0x18 处的那个函数指针，因为我们要调用这个函数::

 0x180002570  e41a 0080 0100 0000 201b 0080 0100 0000  ........ .......
 0x180002580  780a 0080 0100 0000 c00a 0080 0100 0000  x...............
 0x180002590  480b 0080 0100 0000 a00b 0080 0100 0000  H...............
 0x1800025a0  e80b 0080 0100 0000 300c 0080 0100 0000  ........0.......
 0x1800025b0  680c 0080 0100 0000 b00c 0080 0100 0000  h...............
 0x1800025c0  5409 0080 0100 0000 2008 0080 0100 0000  T....... .......
 0x1800025d0  a027 0080 0100 0000 8605 ddd3 6d97 9f44  .'..........m..D

看来这个接口一共有 13 个函数，我们暂时只看 0x18 处的 0x180000ac0. 分析方法还是把它写成 C 代码，代码见 `SmmEcIoDriver.c <SmmEcIoDriver.c>`__.
